
# üöÄ Checklist de Produ√ß√£o: GuaraFood (Windows 10 Edition)

Seu site j√° est√° no Vercel (Frontend), mas para o Pix Autom√°tico funcionar, o **Backend (Supabase Edge Functions)** precisa ser enviado para a nuvem.

## 1. Instala√ß√£o do Ambiente (Apenas na 1¬™ vez)
No Windows 10, abra o **PowerShell** ou **Prompt de Comando (CMD)** como Administrador.

1. **Instalar Node.js:** Baixe e instale a vers√£o LTS do site oficial [nodejs.org](https://nodejs.org).
2. **Verificar instala√ß√£o:**
   ```bash
   node -v
   # Deve aparecer algo como v20.x.x
   ```
3. **Instalar Supabase CLI:**
   ```bash
   npm install -g supabase
   ```

## 2. Login no Supabase
1. No terminal, digite:
   ```bash
   npx supabase login
   ```
2. O navegador abrir√°. Clique em **"Confirm"**.
3. Volte ao terminal, deve aparecer: `You are now logged in`.

## 3. Deploy das Fun√ß√µes (Fazer o Pix Funcionar)
Rode estes comandos um por um na pasta do seu projeto.
*(Substitua `xfousvlrhinlvrpryscy` pelo ID do seu projeto se for diferente)*

1. **Fun√ß√£o de Criar Pagamento:**
   ```bash
   npx supabase functions deploy create-payment --project-ref xfousvlrhinlvrpryscy --no-verify-jwt
   ```
2. **Fun√ß√£o de Confirma√ß√£o (Webhook):**
   ```bash
   npx supabase functions deploy payment-webhook --project-ref xfousvlrhinlvrpryscy --no-verify-jwt
   ```
3. **Fun√ß√£o de Criar Restaurante (Admin):**
   ```bash
   npx supabase functions deploy create-restaurant-with-user --project-ref xfousvlrhinlvrpryscy --no-verify-jwt
   ```
4. **Fun√ß√£o de Excluir Restaurante (Admin):**
   ```bash
   npx supabase functions deploy delete-restaurant-and-user --project-ref xfousvlrhinlvrpryscy --no-verify-jwt
   ```

## 4. Configurar Segredos (Conectar Fun√ß√µes ao Banco)
As fun√ß√µes precisam saber onde fica o banco de dados.

```bash
npx supabase secrets set SUPABASE_URL=https://xfousvlrhinlvrpryscy.supabase.co --project-ref xfousvlrhinlvrpryscy
```

```bash
npx supabase secrets set SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhmb3VzdmxyaGlubHZycHJ5c2N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTg0NDYsImV4cCI6MjA3ODE5NDQ0Nn0.ah4qi9NtkUAyxrcOMPQi9T6pmgEW6ZMHcjhA9tNI8s0 --project-ref xfousvlrhinlvrpryscy
```

## 5. Solu√ß√£o de Problemas de Banco de Dados (SQL Mestre - RLS)

Se voc√™ encontrar erros como `Failed to fetch` ou erro ao carregar o card√°pio, rode este **SCRIPT MESTRE DE PERMISS√ïES** no SQL Editor do Supabase:

```sql
BEGIN;

-- 1. GARANTIR QUE A TABELA DE DESPESAS EXISTA
CREATE TABLE IF NOT EXISTS public.expenses (
    id bigint generated by default as identity primary key,
    restaurant_id bigint references public.restaurants(id) on delete cascade,
    description text not null,
    amount numeric not null,
    category text,
    date timestamp with time zone default now()
);
ALTER TABLE public.expenses ENABLE ROW LEVEL SECURITY;

-- 2. LIMPEZA: REMOVE TODAS AS POL√çTICAS ANTIGAS PARA EVITAR CONFLITOS
DROP POLICY IF EXISTS "Public Read Restaurants" ON public.restaurants;
DROP POLICY IF EXISTS "Public Read Restaurant Categories" ON public.restaurant_categories;
DROP POLICY IF EXISTS "Public Read Menu Categories" ON public.menu_categories;
DROP POLICY IF EXISTS "Public Read Menu Items" ON public.menu_items;
DROP POLICY IF EXISTS "Public Read Combos" ON public.combos;
DROP POLICY IF EXISTS "Public Read Addons" ON public.addons;
DROP POLICY IF EXISTS "Public Read Promotions" ON public.promotions;
DROP POLICY IF EXISTS "Public Read Coupons" ON public.coupons;
DROP POLICY IF EXISTS "Public Read Banners" ON public.banners;
DROP POLICY IF EXISTS "Public Read Orders (basic)" ON public.orders;

DROP POLICY IF EXISTS "Admin/Merchant Update Restaurants" ON public.restaurants;
DROP POLICY IF EXISTS "Admin Insert Restaurants" ON public.restaurants;
DROP POLICY IF EXISTS "Admin Delete Restaurants" ON public.restaurants;
DROP POLICY IF EXISTS "Merchant Manage Categories" ON public.menu_categories;
DROP POLICY IF EXISTS "Merchant Manage Items" ON public.menu_items;
DROP POLICY IF EXISTS "Merchant Manage Combos" ON public.combos;
DROP POLICY IF EXISTS "Merchant Manage Addons" ON public.addons;
DROP POLICY IF EXISTS "Merchant Manage Expenses" ON public.expenses;
DROP POLICY IF EXISTS "Merchant Manage Promotions" ON public.promotions;
DROP POLICY IF EXISTS "Merchant Manage Coupons" ON public.coupons;
DROP POLICY IF EXISTS "Admin Manage Banners" ON public.banners;
DROP POLICY IF EXISTS "Read Own Profile" ON public.profiles;

-- 3. CRIAR POL√çTICAS DE LEITURA P√öBLICA (RESOLVE O "FAILED TO FETCH")
CREATE POLICY "Public Read Restaurants" ON public.restaurants FOR SELECT USING (true);
CREATE POLICY "Public Read Restaurant Categories" ON public.restaurant_categories FOR SELECT USING (true);
CREATE POLICY "Public Read Menu Categories" ON public.menu_categories FOR SELECT USING (true);
CREATE POLICY "Public Read Menu Items" ON public.menu_items FOR SELECT USING (true);
CREATE POLICY "Public Read Combos" ON public.combos FOR SELECT USING (true);
CREATE POLICY "Public Read Addons" ON public.addons FOR SELECT USING (true);
CREATE POLICY "Public Read Promotions" ON public.promotions FOR SELECT USING (true);
CREATE POLICY "Public Read Coupons" ON public.coupons FOR SELECT USING (true);
CREATE POLICY "Public Read Banners" ON public.banners FOR SELECT USING (true);
CREATE POLICY "Public Read Orders (basic)" ON public.orders FOR SELECT USING (true);

-- 4. CRIAR POL√çTICAS DE ADMINISTRA√á√ÉO (PARA O LOJISTA)
CREATE POLICY "Read Own Profile" ON public.profiles FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Merchant Manage Expenses" ON public.expenses FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE restaurant_id = expenses.restaurant_id OR role = 'admin'));

CREATE POLICY "Admin/Merchant Update Restaurants" ON public.restaurants FOR UPDATE USING (auth.uid() IN (SELECT id FROM profiles WHERE role = 'admin' OR restaurant_id = restaurants.id));
CREATE POLICY "Admin Insert Restaurants" ON public.restaurants FOR INSERT WITH CHECK (auth.uid() IN (SELECT id FROM profiles WHERE role = 'admin'));
CREATE POLICY "Admin Delete Restaurants" ON public.restaurants FOR DELETE USING (auth.uid() IN (SELECT id FROM profiles WHERE role = 'admin'));

CREATE POLICY "Merchant Manage Categories" ON public.menu_categories FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE restaurant_id = menu_categories.restaurant_id OR role = 'admin'));
CREATE POLICY "Merchant Manage Items" ON public.menu_items FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE restaurant_id = menu_items.restaurant_id OR role = 'admin'));
CREATE POLICY "Merchant Manage Combos" ON public.combos FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE restaurant_id = combos.restaurant_id OR role = 'admin'));
CREATE POLICY "Merchant Manage Addons" ON public.addons FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE restaurant_id = addons.restaurant_id OR role = 'admin'));
CREATE POLICY "Merchant Manage Promotions" ON public.promotions FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE restaurant_id = promotions.restaurant_id OR role = 'admin'));
CREATE POLICY "Merchant Manage Coupons" ON public.coupons FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE restaurant_id = coupons.restaurant_id OR role = 'admin'));

CREATE POLICY "Admin Manage Banners" ON public.banners FOR ALL USING (auth.uid() IN (SELECT id FROM profiles WHERE role = 'admin'));

COMMIT;
```

## 6. Configurar Armazenamento de Imagens e Triggers

Este script garante que voc√™ possa fazer upload de fotos dos pratos e que os usu√°rios sejam criados corretamente.

```sql
BEGIN;

-- =========================================================
-- 1. CONFIGURA√á√ÉO DE ARMAZENAMENTO (STORAGE)
-- =========================================================

-- Cria√ß√£o dos Buckets (Pastas) para Imagens
INSERT INTO storage.buckets (id, name, public)
VALUES ('product-images', 'product-images', true)
ON CONFLICT (id) DO NOTHING;

INSERT INTO storage.buckets (id, name, public)
VALUES ('restaurant-logos', 'restaurant-logos', true)
ON CONFLICT (id) DO NOTHING;

-- Remover pol√≠ticas antigas para evitar conflitos
DROP POLICY IF EXISTS "Public Read Product Images" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated Upload Product Images" ON storage.objects;
DROP POLICY IF EXISTS "Merchant Update Product Images" ON storage.objects;
DROP POLICY IF EXISTS "Merchant Delete Product Images" ON storage.objects;

DROP POLICY IF EXISTS "Public Read Logos" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated Upload Logos" ON storage.objects;
DROP POLICY IF EXISTS "Merchant Update Logos" ON storage.objects;

-- Pol√≠ticas para IMAGENS DE PRODUTOS
CREATE POLICY "Public Read Product Images"
ON storage.objects FOR SELECT
USING ( bucket_id = 'product-images' );

CREATE POLICY "Authenticated Upload Product Images"
ON storage.objects FOR INSERT
WITH CHECK ( bucket_id = 'product-images' AND auth.role() = 'authenticated' );

CREATE POLICY "Merchant Update Product Images"
ON storage.objects FOR UPDATE
USING ( bucket_id = 'product-images' AND auth.role() = 'authenticated' );

CREATE POLICY "Merchant Delete Product Images"
ON storage.objects FOR DELETE
USING ( bucket_id = 'product-images' AND auth.role() = 'authenticated' );

-- Pol√≠ticas para LOGOS DE RESTAURANTES
CREATE POLICY "Public Read Logos"
ON storage.objects FOR SELECT
USING ( bucket_id = 'restaurant-logos' );

CREATE POLICY "Authenticated Upload Logos"
ON storage.objects FOR INSERT
WITH CHECK ( bucket_id = 'restaurant-logos' AND auth.role() = 'authenticated' );

CREATE POLICY "Merchant Update Logos"
ON storage.objects FOR UPDATE
USING ( bucket_id = 'restaurant-logos' AND auth.role() = 'authenticated' );


-- =========================================================
-- 2. GATILHO AUTOM√ÅTICO DE USU√ÅRIOS (TRIGGERS)
-- =========================================================

-- Fun√ß√£o que roda automaticamente quando um usu√°rio √© criado
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, email, role, restaurant_id, name)
  VALUES (
    new.id,
    new.email,
    COALESCE(new.raw_user_meta_data->>'role', 'customer'),
    (new.raw_user_meta_data->>'restaurantId')::bigint,
    COALESCE(new.raw_user_meta_data->>'name', 'Novo Usu√°rio')
  )
  ON CONFLICT (id) DO NOTHING; -- Evita erro se j√° existir
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Cria o gatilho (Trigger)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

COMMIT;
```

## 7. Atualiza√ß√£o de Estrutura (Migra√ß√£o Final)

Se o banco de dados for antigo, algumas colunas novas (Taxa de Entrega, Pix Manual) podem estar faltando. Rode este script para garantir que tudo est√° atualizado.

```sql
BEGIN;

-- 1. Atualizar Tabela de Restaurantes
ALTER TABLE public.restaurants ADD COLUMN IF NOT EXISTS delivery_fee numeric DEFAULT 0;
ALTER TABLE public.restaurants ADD COLUMN IF NOT EXISTS manual_pix_key text;
ALTER TABLE public.restaurants ADD COLUMN IF NOT EXISTS mercado_pago_credentials jsonb DEFAULT '{}';

-- 2. Atualizar Tabela de Categorias do Card√°pio (√çcones)
ALTER TABLE public.menu_categories ADD COLUMN IF NOT EXISTS icon_url text;

-- 3. Inserir Categorias Padr√£o de Restaurante (se estiver vazio)
INSERT INTO public.restaurant_categories (name)
SELECT 'Lanches' WHERE NOT EXISTS (SELECT 1 FROM public.restaurant_categories WHERE name = 'Lanches');

INSERT INTO public.restaurant_categories (name)
SELECT 'Pizza' WHERE NOT EXISTS (SELECT 1 FROM public.restaurant_categories WHERE name = 'Pizza');

INSERT INTO public.restaurant_categories (name)
SELECT 'A√ßa√≠' WHERE NOT EXISTS (SELECT 1 FROM public.restaurant_categories WHERE name = 'A√ßa√≠');

INSERT INTO public.restaurant_categories (name)
SELECT 'Japonesa' WHERE NOT EXISTS (SELECT 1 FROM public.restaurant_categories WHERE name = 'Japonesa');

INSERT INTO public.restaurant_categories (name)
SELECT 'Brasileira' WHERE NOT EXISTS (SELECT 1 FROM public.restaurant_categories WHERE name = 'Brasileira');

COMMIT;
```

## 8. Corre√ß√£o de Permiss√µes "Blindada" (Resolve erro de cria√ß√£o)

Se voc√™ tiver problemas para criar itens (erro "new row violates row-level security policy"), rode este script. Ele libera a leitura do perfil e usa uma verifica√ß√£o mais robusta.

```sql
BEGIN;

-- 1. CORRE√á√ÉO DE PERFIL (Essencial para as outras regras funcionarem)
DROP POLICY IF EXISTS "Read Own Profile" ON public.profiles;
CREATE POLICY "Read Own Profile" ON public.profiles FOR SELECT USING (auth.uid() = id);

-- 2. ADICIONAIS (Corre√ß√£o do erro atual)
DROP POLICY IF EXISTS "Merchant Manage Addons" ON public.addons;
DROP POLICY IF EXISTS "Merchant Insert Addons" ON public.addons;
DROP POLICY IF EXISTS "Merchant Update Addons" ON public.addons;
DROP POLICY IF EXISTS "Merchant Delete Addons" ON public.addons;

CREATE POLICY "Merchant Insert Addons" ON public.addons FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = addons.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Update Addons" ON public.addons FOR UPDATE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = addons.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Delete Addons" ON public.addons FOR DELETE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = addons.restaurant_id OR profiles.role = 'admin'))
);

-- 3. REPLICAR PARA OUTRAS TABELAS (Preven√ß√£o)

-- Itens
DROP POLICY IF EXISTS "Merchant Manage Items" ON public.menu_items;
DROP POLICY IF EXISTS "Merchant Insert Items" ON public.menu_items;
DROP POLICY IF EXISTS "Merchant Update Items" ON public.menu_items;
DROP POLICY IF EXISTS "Merchant Delete Items" ON public.menu_items;

CREATE POLICY "Merchant Insert Items" ON public.menu_items FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = menu_items.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Update Items" ON public.menu_items FOR UPDATE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = menu_items.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Delete Items" ON public.menu_items FOR DELETE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = menu_items.restaurant_id OR profiles.role = 'admin'))
);

-- Combos
DROP POLICY IF EXISTS "Merchant Manage Combos" ON public.combos;
DROP POLICY IF EXISTS "Merchant Insert Combos" ON public.combos;
DROP POLICY IF EXISTS "Merchant Update Combos" ON public.combos;
DROP POLICY IF EXISTS "Merchant Delete Combos" ON public.combos;

CREATE POLICY "Merchant Insert Combos" ON public.combos FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = combos.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Update Combos" ON public.combos FOR UPDATE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = combos.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Delete Combos" ON public.combos FOR DELETE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = combos.restaurant_id OR profiles.role = 'admin'))
);

-- Categorias
DROP POLICY IF EXISTS "Merchant Manage Categories" ON public.menu_categories;
DROP POLICY IF EXISTS "Merchant Insert Categories" ON public.menu_categories;
DROP POLICY IF EXISTS "Merchant Update Categories" ON public.menu_categories;
DROP POLICY IF EXISTS "Merchant Delete Categories" ON public.menu_categories;

CREATE POLICY "Merchant Insert Categories" ON public.menu_categories FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = menu_categories.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Update Categories" ON public.menu_categories FOR UPDATE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = menu_categories.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Delete Categories" ON public.menu_categories FOR DELETE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = menu_categories.restaurant_id OR profiles.role = 'admin'))
);

-- Promo√ß√µes
DROP POLICY IF EXISTS "Merchant Manage Promotions" ON public.promotions;
CREATE POLICY "Merchant Insert Promotions" ON public.promotions FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = promotions.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Update Promotions" ON public.promotions FOR UPDATE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = promotions.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Delete Promotions" ON public.promotions FOR DELETE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = promotions.restaurant_id OR profiles.role = 'admin'))
);

-- Cupons
DROP POLICY IF EXISTS "Merchant Manage Coupons" ON public.coupons;
CREATE POLICY "Merchant Insert Coupons" ON public.coupons FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = coupons.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Update Coupons" ON public.coupons FOR UPDATE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = coupons.restaurant_id OR profiles.role = 'admin'))
);
CREATE POLICY "Merchant Delete Coupons" ON public.coupons FOR DELETE USING (
  EXISTS (SELECT 1 FROM profiles WHERE profiles.id = auth.uid() AND (profiles.restaurant_id = coupons.restaurant_id OR profiles.role = 'admin'))
);

COMMIT;
```
